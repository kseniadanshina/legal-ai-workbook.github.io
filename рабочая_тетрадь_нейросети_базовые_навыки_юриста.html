<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Рабочая тетрадь. Нейросети: базовые навыки юриста</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#dae3ea; --card:#ffffff; --muted:#5c6775; --text:#0a0a0a; --accent:#f7624f; --accent-2:#d94a36; --border:#cfd8e3; --danger:#e15249; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Raleway, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
    .title{font-size:28px; font-weight:700; letter-spacing:.2px; margin:0 0 8px}
    .subtitle{color:var(--muted); margin:0 0 20px; line-height:1.5}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){ .grid.cols-4{grid-template-columns:repeat(4,1fr)} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    select, input[type="text"], textarea{ width:100%; background:#fff; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none; transition:border .15s ease, box-shadow .15s ease; font-family:Raleway, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:14px; }
    select:focus, input[type="text"]:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(247,98,79,.15)}
    textarea{min-height:92px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{appearance:none; border:1px solid var(--border); background:var(--accent); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; font-size:14px; font-family:Raleway}
    .btn:hover{background:var(--accent-2)}
    .btn.ghost{background:transparent; color:var(--accent); border-color:var(--accent)}
    .btn.ghost:hover{color:#fff; background:var(--accent)}
    .btn.danger{background:#fff; color:var(--danger); border-color:var(--danger)}
    .btn.danger:hover{background:var(--danger); color:#fff}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin:12px 0 8px}
    .hint{font-size:12px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:#5c6775; font-size:12px}

    .table-card{margin-top:16px}
    .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
    table{width:100%; min-width:1100px; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--border); background:#fff; font-family:Raleway; font-size:14px}
    thead th{position:sticky; top:0; background:var(--accent); z-index:1; text-align:left; font-size:14px; color:#fff; padding:12px; border-bottom:1px solid var(--border)}
    tbody td{padding:12px; border-bottom:1px solid var(--border); vertical-align:top; font-size:14px}
    tbody tr:hover{background:#f7fbff}
    td .cell{min-height:24px; font-size:14px; word-break:break-word; white-space:pre-wrap}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .settings{display:none; margin-top:12px}
    .settings.open{display:block}
    .settings .row{align-items:flex-end}

    .sync-ind{font-size:12px; margin-left:8px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .sync-ind.idle{color:#5c6775}
    .sync-ind.working{color:#f7624f}
    .sync-ind.ok{color:#2e7d32}
    .sync-ind.err{color:#c62828}

    .diag{margin:12px 0; padding:8px 12px; border-radius:8px; background:#fff; border:1px dashed var(--border); font-size:12px; color:#334155}
    .grid > div:has(> #instrument),
    .grid > div:has(> #context),
    .grid > div:has(> #prompt),
    .grid > div:has(> #comment){
      grid-column: 1 / -1;
    }
     #instrument, #context, #prompt, #comment { max-width:100%; }
    #instrument, #context, #prompt, #comment { min-height: 48px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Рабочая тетрадь. Нейросети: базовые навыки юриста</h1>
    <p class="subtitle">Заполняйте карточку задачи и добавляйте её в таблицу. Данные хранятся локально в браузере. Можно редактировать, удалять, искать и выгружать в Excel/CSV. При желании — можно подключить синхронизацию в Google Sheets (инструкция внизу страницы).</p>

    <div id="diag" class="diag" style="display:none"></div>

    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle" class="sr-only">Добавить задачу</h2>
      <div class="grid cols-4" style="margin-bottom:8px">
        <div>
          <label for="taskClass">Класс задачи</label>
          <textarea id="taskClass" placeholder="Напр.: Поиск информации, анализ информации, созданеи текстов, переформулирование текстов, переформатирование текстов, помощь с рассуждением, сочетание сценариев"></textarea>
        </div>
        <div>
          <label for="taskTitle">Краткое описание задачи (обязательно) </label>
          <textarea id="taskTitle" placeholder="Напр.: Переписать текст заключения на понятном менеджеру языке"></textarea>
        </div>
        <div>
          <label for="model">Модель</label>
          <select id="model">
            <option>ChatGPT</option>
            <option>Claude</option>
            <option>Gemini</option>
            <option>Google AI Studio</option>
            <option>Perplexity</option>
            <option>NotebookLM</option>
            <option>Локальная модель</option>
            <option>Другое</option>
          </select>
        </div>
        <div>
          <label for="modelVersion">Версия модели</label>
          <input id="modelVersion" type="text" placeholder="Напр.: GPT-5, Claude 3.5 Sonnet" />
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="instrument">Инструмент</label>
          <textarea id="instrument" placeholder="Напр.: Поиск в Интернете, глубокое исследование, проекты, низкая температура"></textarea>
        </div>
        <div>
          <label for="context">Контекст (данные/ограничения)</label>
          <textarea id="context" placeholder="Напр.: подробное описание стиля ИЛИ Документы"></textarea>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div>
          <label for="prompt">Промптинг (обязательно)</label>
          <textarea id="prompt" placeholder="Напр.: Ищи только на kad.arbitr.ru, zakon.ru, в обзорах юрфирм. Приводи только факты. Если точной информации нет — скажи об этом прямо, не додумывай."></textarea>
        </div>
        <div>
          <label for="comment">Комментарий / Ваши действия </label>
          <textarea id="comment" placeholder="Напр.: Модель всегда теряет пункт о неустойке; проверить формулировку п.4.2. ИЛИ Всегда использовать несколько итераций ИЛИ Всегда перепроверять первоисточники "></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="addBtn">Добавить в таблицу</button>
        <span class="hint">После добавления можно редактировать ячейки прямо в таблице.</span>
      </div>
    </section>

    <section class="table-card card">
      <div class="toolbar">
        <div class="row">
          <button class="btn ghost" id="exportXlsx">Экспорт в Excel (.xlsx)</button>
          <button class="btn ghost" id="exportCsv">Экспорт в CSV</button>
          <button class="btn ghost" id="clearAll">Очистить всё</button>
          <button class="btn ghost" id="toggleSettings">Google Sheets</button>
        </div>
        <div class="row">
          <input id="searchInput" type="text" placeholder="Поиск по таблице…" />
          <span class="badge" title="Индикатор записей"><span id="count">0</span> записей</span>
          <details id="syncBox" class="badge" style="border:none; padding:0; background:transparent">
            <summary id="syncIndicator" class="sync-ind idle" style="list-style:none; cursor:pointer">Sheets: выкл.</summary>
            <pre id="syncDetail" class="hint" style="margin:8px 0 0; white-space:pre-wrap"></pre>
          </details>
        </div>
      </div>

      <div id="settingsPanel" class="settings">
        <div class="row">
          <div style="flex:1; min-width:280px">
            <label for="gsUrl">URL вашего Google Apps Script (Web App)</label>
            <input id="gsUrl" type="text" placeholder="https://script.google.com/macros/s/…/exec" />
          </div>
          <button class="btn" id="saveGsUrl">Сохранить</button>
          <button class="btn ghost" id="testSync">Тестовая синхронизация</button>
          <button class="btn ghost" id="pullFromSheets">Загрузить из Sheets</button>
        </div>
        <p class="hint">URL хранится только у вас в браузере. Если оставить пустым — тетрадь работает локально.</p>
        <p id="syncLog" class="hint" style="margin-top:6px"></p>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="dataTable" aria-describedby="tableHelp">
          <thead>
            <tr>
              <th>Класс задачи</th>
              <th>Описание задачи</th>
              <th>Модель</th>
              <th>Версия модели</th>
              <th>Инструмент</th>
              <th>Контекст</th>
              <th>Промптинг</th>
              <th>Комментарий</th>
              <th style="width:64px">Действия</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr class="empty-row"><td colspan="10"><div class="empty">Пока пусто. Заполните форму выше и добавьте первую запись.</div></td></tr>
          </tbody>
        </table>
        <p id="tableHelp" class="hint" style="margin-top:8px">Кликните по ячейке, чтобы отредактировать. Изменения сохраняются автоматически, в том числе в Google Sheets при синхронизации.</p>
      </div>
    </section>

    <p class="hint" style="margin-top:12px">Данные хранятся локально. При включённой связке с Google Sheets — дублируются в ваш лист.</p>


  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  (function(){
    'use strict';

    const diagBox = document.getElementById('diag');
    function diag(msg){ try{ diagBox.style.display='block'; diagBox.textContent = String(msg); }catch(_){} }
    window.addEventListener('error', function(e){ diag('Ошибка: '+e.message); });

    function boot(){
      if (window.__legalAIMatrixBooted) return; window.__legalAIMatrixBooted = true;
      const $ = id => document.getElementById(id);
      const on = (id, evt, fn) => { const el = $(id); if (el) el.addEventListener(evt, fn); else diag('Нет элемента #'+id); };

      const tbody = $('tbody');
      const countBadge = $('count');
      const searchInput = $('searchInput');
      const pullBtn = $('pullFromSheets');

      const STORAGE_KEY = 'legal-ai-matrix-v1';
      const STORAGE_KEY_GS = 'gs_url';
      const SHEET_HEADERS = ['ID','Класс задачи','Описание задачи','Модель','Версия модели','Инструмент','Контекст','Промптинг','Комментарий'];

      function loadData(){ const raw = localStorage.getItem(STORAGE_KEY); try { return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
      function saveData(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); updateCount(); queueSync(rows); }
      function getDataFromTable(){ const rows = []; tbody.querySelectorAll('tr.data-row').forEach(tr=>{ const obj={}; tr.querySelectorAll('[data-col]').forEach(td=>{ obj[td.getAttribute('data-col')] = (td.innerText||'').trim(); }); obj.ID = tr.dataset.id||''; rows.push(obj); }); return rows; }
      function generateId(){ return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

      function addRowToDom(row){ const tr=document.createElement('tr'); tr.className='data-row'; tr.dataset.id = row.ID && String(row.ID).trim() ? row.ID : generateId(); tr.innerHTML=
        '<td data-col="Класс задачи" contenteditable class="cell">'+escapeHtml(row['Класс задачи']||'')+'</td>'+
        '<td data-col="Описание задачи" contenteditable class="cell">'+escapeHtml(row['Описание задачи']||'')+'</td>'+
        '<td data-col="Модель" contenteditable class="cell">'+escapeHtml(row['Модель']||'')+'</td>'+
        '<td data-col="Версия модели" contenteditable class="cell">'+escapeHtml(row['Версия модели']||'')+'</td>'+
        '<td data-col="Инструмент" contenteditable class="cell">'+escapeHtml(row['Инструмент']||'')+'</td>'+
        '<td data-col="Контекст" contenteditable class="cell">'+escapeHtml(row['Контекст']||'')+'</td>'+
        '<td data-col="Промптинг" contenteditable class="cell">'+escapeHtml(row['Промптинг']||'')+'</td>'+
        '<td data-col="Комментарий" contenteditable class="cell">'+escapeHtml(row['Комментарий']||'')+'</td>'+
        '<td><button class="btn danger" onclick="deleteRow(this)" title="Удалить">Удалить</button></td>';
        const emptyRow = tbody.querySelector('.empty-row');
        if (emptyRow) emptyRow.remove();
        tr.querySelectorAll('[contenteditable]').forEach(cell=>{ cell.addEventListener('input', ()=> saveData(getDataFromTable())); });
        tbody.appendChild(tr);
      }

      function render(rows){
        tbody.innerHTML='';
        if(!rows || !rows.length){
          const tr=document.createElement('tr');
          tr.className='empty-row';
          tr.innerHTML='<td colspan="10"><div class="empty">Пока пусто. Заполните форму выше и добавьте первую запись.</div></td>';
          tbody.appendChild(tr);
      } else {
        rows.forEach(addRowToDom);
      }
      updateCount();
      }

      render(loadData()); // ИСПРАВЛЕНИЕ: Загрузка данных из localStorage при инициализации

      function addFromForm(){ const row={ 'Класс задачи': $('taskClass').value.trim(), 'Описание задачи': $('taskTitle').value.trim(), 'Модель': $('model').value.trim(), 'Версия модели': $('modelVersion').value.trim(), 'Инструмент': $('instrument').value.trim(), 'Контекст': $('context').value.trim(), 'Промптинг': $('prompt').value.trim(), 'Комментарий': $('comment').value.trim() }; if(!row['Описание задачи']||!row['Промптинг']){ alert('Пожалуйста, заполните как минимум «Описание задачи» и «Промптинг».'); return;} addRowToDom(row); saveData(getDataFromTable()); clearForm(); }
      function clearForm(){ ['taskTitle','context','prompt','comment','modelVersion','instrument'].forEach(id=>$(id).value=''); }
      function deleteRow(btn){ const tr = btn.closest('tr'); const id = tr ? tr.dataset.id : ''; if(!confirm('Удалить эту строку из локальной таблицы?')) return; if(!confirm('Точно удалить? Действие нельзя отменить.')) return; tr.remove(); const rows = getDataFromTable(); saveData(rows); }
      window.deleteRow = deleteRow;

      function updateCount(){ const n = tbody.querySelectorAll('tr.data-row').length; countBadge.textContent = String(n); }
      function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function applySearch(){ const q=(searchInput.value||'').toLowerCase().trim(); [].forEach.call(tbody.querySelectorAll('tr.data-row'), tr=>{ const text=(tr.innerText||'').toLowerCase(); tr.style.display = text.indexOf(q)!==-1 ? '' : 'none'; }); }

      function exportCSV(){ const headers=SHEET_HEADERS; const rows=getDataFromTable(); const esc=v=>'"'+String(v||'').replace(/"/g,'""')+'"'; const csv=[headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n'); const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='legal-ai-matrix.csv'; a.click(); URL.revokeObjectURL(a.href); }
      function exportXLSX(){ const headers=SHEET_HEADERS; const rows=getDataFromTable(); const data=rows.map(r=>headers.map(h=>r[h]||'')); const ws=XLSX.utils.aoa_to_sheet([headers].concat(data)); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Матрица'); XLSX.writeFile(wb, 'legal-ai-matrix.xlsx'); }

      function setSync(state,msg){ const summary=document.getElementById('syncIndicator'); const detail=document.getElementById('syncDetail'); const textByState={ off:'Sheets: выкл.', working:'Sheets: отправка…', ok:'Sheets: OK', err:'Sheets: ошибка' }; if(summary){ summary.classList.remove('idle','working','ok','err'); if(state==='off'){ summary.textContent=textByState.off; summary.classList.add('idle'); } else if(state==='working'){ summary.textContent=textByState.working; summary.classList.add('working'); } else if(state==='ok'){ summary.textContent=textByState.ok; summary.classList.add('ok'); } else if(state==='err'){ summary.textContent=textByState.err; summary.classList.add('err'); } else { summary.textContent='Sheets: готово'; summary.classList.add('idle'); } } if(detail){ const stamp=new Date().toLocaleString(); detail.textContent = msg ? ('['+stamp+'] '+msg) : ''; } }

      let syncTimer=null;
      function queueSync(rows){ clearTimeout(syncTimer); const GS_URL=(localStorage.getItem(STORAGE_KEY_GS)||'').trim(); if(!GS_URL){ setSync('off'); return;} syncTimer=setTimeout(()=>syncToSheets(rows),600); }

      function syncToSheets(rows){ const GS_URL=(localStorage.getItem(STORAGE_KEY_GS)||'').trim(); if(!GS_URL||!validateGsUrl(GS_URL)){ setSync('off','URL не задан или некорректен'); return;} setSync('working','Синхронизация…'); const sentIds=(rows||[]).map(r=>r.ID).filter(Boolean);
        fetch(GS_URL,{ method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ action:'upsertMany', headers:SHEET_HEADERS, rows: rows||[] }) })
        .then(r=>r.text().then(t=>({ok:r.ok,status:r.status,text:t})))
        .then(resp=>{ let data=null; try{ data = resp.text ? JSON.parse(resp.text) : null; }catch(e){ data={ raw: resp.text }; } if(!resp.ok){ throw new Error((data&&(data.error||data.message))||('HTTP '+resp.status)); } const msg = data && (data.message || ('OK (updated:'+data.updated+' appended:'+data.appended+')')); setSync('ok',(msg||'OK') + (sentIds.length?(' | sent ids: '+sentIds.join(', ')):'')); })
        .catch(err=> setSync('err', (err&&err.message)?err.message:'Network/CORS error'));
      }

      async function pingSheets(){ const GS_URL=(localStorage.getItem(STORAGE_KEY_GS)||'').trim(); if(!GS_URL){ setSync('off','URL не задан'); return;} if(!validateGsUrl(GS_URL)){ setSync('err','Некорректный URL GAS'); return;} setSync('working','Проверка подключения…'); try{ const r=await fetch(GS_URL,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action:'ping' }) }); const txt=await r.text(); let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch(e){} if(!r.ok) throw new Error((data&&(data.error||data.message))||txt||('HTTP '+r.status)); setSync('ok', (data&&(data.message||'POST OK'))||'POST OK'); }catch(e){ setSync('err','POST: '+(e&&e.message?e.message:'error')); } }
      async function pullFromSheets(){ const GS_URL=(localStorage.getItem(STORAGE_KEY_GS)||'').trim(); if(!GS_URL||!validateGsUrl(GS_URL)){ setSync('err','URL не задан или некорректен'); return;} setSync('working','Загрузка из Sheets…'); try{ const url=GS_URL+'?action=pullAll'; const r=await fetch(url,{method:'GET'}); const txt=await r.text(); let data=null; try{ data = txt ? JSON.parse(txt) : null; }catch(e){} if(!r.ok) throw new Error((data&&(data.error||data.message))||txt||('HTTP '+r.status)); if(!data||!Array.isArray(data.rows)) throw new Error('Некорректный ответ pullAll'); render([]); data.rows.forEach(addRowToDom); saveData(getDataFromTable()); setSync('ok','Импортировано из Sheets: '+data.rows.length); }catch(e){ setSync('err', e&&e.message?e.message:'pullAll error'); } }

      function validateGsUrl(u){ u=(u||'').trim(); return u.startsWith('https://script.google.com/macros/s/') && u.endsWith('/exec'); }
      function loadSettings(){ $('gsUrl').value = localStorage.getItem(STORAGE_KEY_GS) || ''; }
      function saveSettings(){ const val=($('gsUrl').value||'').trim(); if(val && !validateGsUrl(val)){ alert('Проверьте URL: должен оканчиваться на /exec и быть из Google Apps Script Web App'); return;} localStorage.setItem(STORAGE_KEY_GS, val); const has=!!(localStorage.getItem(STORAGE_KEY_GS)); alert('URL сохранён. ' + (has ? 'Изменения будут синхронинизироваться в ваш Google Sheets.' : 'Синхронизация отключена.')); setSync(has?'idle':'off'); if(has) pingSheets().then(()=> queueSync(getDataFromTable())); }

      on('addBtn','click', addFromForm);
      on('exportCsv','click', exportCSV);
      on('exportXlsx','click', exportXLSX);
      on('clearAll','click', function(){ if(confirm('Удалить все локальные записи? На Google Sheets это не повлияет.')){ localStorage.removeItem(STORAGE_KEY); render([]); setSync('idle','Локальные данные очищены; Sheets не трогаем'); } });
      if (searchInput) searchInput.addEventListener('input', applySearch);
      on('toggleSettings','click', function(){ const panel=document.getElementById('settingsPanel'); panel.classList.toggle('open'); if(panel.classList.contains('open')) loadSettings(); });
      on('saveGsUrl','click', saveSettings);
      if (pullBtn){ pullBtn.addEventListener('click', function(){ pullFromSheets(); }); }
      on('testSync','click', function(){ pingSheets(); });

      (function runTests(){ let passed=0, failed=0, notes=[]; function assert(name, cond){ if(cond){passed++;} else {failed++; notes.push('FAIL: '+name);} }
        const headers=['A','B']; const rows=[{'A':'x','B':'y'}]; const esc=v=>'"'+String(v||'').replace(/"/g,'""')+'"'; const csv=[headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n'); assert('csv has 2 lines', csv.split('\n').length===2); assert('csv row content', csv.indexOf('"x","y"')!==-1); assert('validateGsUrl ok', (function(u){u='https://script.google.com/macros/s/ABC/exec'; return u.startsWith('https://script.google.com/macros/s/')&&u.endsWith('/exec');})()===true); assert('validateGsUrl reject', (function(u){u='https://script.google.com/macros/s/ABC/dev'; return u.startsWith('https://script.google.com/macros/s/')&&u.endsWith('/exec');})()===false); const id1=generateId(), id2=generateId(); assert('ID non-empty', typeof id1==='string'&&id1.length>5); assert('IDs unique', id1!==id2); const domRows=getDataFromTable(); assert('every row has ID', domRows.every(r=>r.ID && r.ID.length>0)); console.log('Self-tests:', {passed, failed, notes}); })();

      setTimeout(function(){ const u=(localStorage.getItem(STORAGE_KEY_GS)||'').trim(); if(u) pingSheets(); }, 1200);
    }
    boot();
  })();
  </script>
</body>
</html>